<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Production Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e1a; --bg-secondary: #131829; --bg-card: #1a1f35; --bg-hover: #222744;
      --accent-primary: #00d4ff; --accent-secondary: #7c3aed; --accent-success: #10b981;
      --accent-warning: #f59e0b; --accent-danger: #ef4444; --text-primary: #ffffff;
      --text-secondary: #94a3b8; --text-muted: #64748b; --border: #2d3548;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Outfit', sans-serif; background: var(--bg-primary); color: var(--text-primary); }
    body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(124, 58, 237, 0.1) 0%, transparent 50%); pointer-events: none; z-index: 0; }
    .container { position: relative; z-index: 1; max-width: 1600px; margin: 0 auto; padding: 2rem; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .header-left h1 { font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
    .header-left p { color: var(--text-secondary); }
    .header-right { display: flex; align-items: center; gap: 1rem; }
    .user-info { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 212, 255, 0.3); }
    .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-hover); border-color: var(--accent-primary); }
    .current-table-banner { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem; text-align: center; box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3); }
    .current-table-banner h2 { margin: 0; font-size: 1.5rem; color: white; }
    .filter-section { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border); }
    .filter-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; }
    .filter-group label { display: block; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 500; }
    .filter-input { width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'Outfit', sans-serif; font-size: 0.95rem; transition: all 0.3s ease; }
    .filter-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1); }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-5px); border-color: var(--accent-primary); box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2); }
    .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .stat-icon.total { background: rgba(0, 212, 255, 0.15); }
    .stat-icon.pass { background: rgba(16, 185, 129, 0.15); }
    .stat-icon.fail { background: rgba(239, 68, 68, 0.15); }
    .stat-icon.rate { background: rgba(124, 58, 237, 0.15); }
    .stat-label { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; }
    .stat-value { font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
    .stat-value.success { background: linear-gradient(135deg, #10b981, #34d399); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-value.danger { background: linear-gradient(135deg, #ef4444, #f87171); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-subtext { color: var(--text-muted); font-size: 0.85rem; }
    .table-section { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); overflow-x: auto; }
    .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    thead tr { border-bottom: 2px solid var(--border); }
    th { text-align: left; padding: 1rem; color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; white-space: nowrap; }
    tbody tr { border-bottom: 1px solid var(--border); transition: all 0.3s ease; cursor: pointer; }
    tbody tr:hover { background: var(--bg-hover); }
    td { padding: 1rem; color: var(--text-primary); }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 26, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s ease; }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: var(--bg-card); border-radius: 16px; width: 90%; max-width: 1200px; max-height: 90vh; overflow: hidden; border: 1px solid var(--border); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 2rem; cursor: pointer; width: 40px; height: 40px; border-radius: 8px; transition: all 0.3s ease; }
    .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
    .modal-body { padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 140px); }
    .detail-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .detail-table thead tr { background: var(--bg-secondary); position: sticky; top: 0; z-index: 10; }
    .detail-table th { padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid var(--border); }
    .detail-table td { padding: 0.75rem; border-bottom: 1px solid var(--border); }
    .detail-table tbody tr:hover { background: var(--bg-hover); }
    .no-data-message { text-align: center; padding: 3rem; color: var(--text-secondary); }
    .error-message { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--accent-danger); border-radius: 12px; padding: 2rem; text-align: center; margin: 2rem 0; }
    .error-message h3 { color: var(--accent-danger); margin-bottom: 1rem; }
    @media (max-width: 1200px) { .filter-grid { grid-template-columns: repeat(3, 1fr); } .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .container { padding: 1rem; } .header { flex-direction: column; align-items: flex-start; gap: 1rem; } .filter-grid, .stats-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="loading-overlay hidden" id="loadingOverlay"><div class="spinner"></div></div>
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="modalTitle">Record Details</h2><button class="modal-close" onclick="closeModal()">&times;</button></div>
      <div class="modal-body"><div id="modalContent"></div></div>
    </div>
  </div>
  <div class="container">
    <header class="header">
      <div class="header-left"><h1>MLTesting Production Dashboard</h1><p id="currentDate">Loading...</p></div>
      <div class="header-right">
        <div class="user-info"><div class="user-avatar" id="userAvatar">U</div><div><div style="font-weight: 600;" id="userName">User</div><div style="font-size: 0.85rem; color: var(--text-muted);" id="userRole">Operator</div></div></div>
        <button class="btn btn-secondary" onclick="openSettings()">‚öôÔ∏è Settings</button>
        <button class="btn btn-secondary" onclick="logout()">Logout</button>
      </div>
    </header>
    <div class="current-table-banner"><h2>üìä Currently Viewing: <span id="currentTableDisplay">Loading...</span></h2></div>
    <div id="errorContainer"></div>
    <section class="filter-section">
      <div class="filter-grid">
        <div class="filter-group"><label for="tableSelector">Select Table</label><select id="tableSelector" class="filter-input"><option value="">Loading...</option></select></div>
        <div class="filter-group"><label for="dateFilter">Select Date</label><input type="date" id="dateFilter" class="filter-input"></div>
        <div class="filter-group"><label for="shiftFilter">Shift</label><select id="shiftFilter" class="filter-input"><option value="all">All Shifts</option><option value="morning">Morning (6AM - 2PM)</option><option value="afternoon">Afternoon (2PM - 10PM)</option><option value="night">Night (10PM - 6AM)</option></select></div>
        <div class="filter-group"><label for="identifierFilter" id="identifierLabel">Filter</label><select id="identifierFilter" class="filter-input"><option value="all">All</option></select></div>
        <div class="filter-group" style="display: flex; align-items: flex-end;"><button class="btn btn-primary" onclick="applyFilters()" style="width: 100%;">üîç Apply Filters</button></div>
      </div>
    </section>
    <section class="stats-grid">
      <div class="stat-card"><div class="stat-header"><div class="stat-icon total">üì¶</div></div><div class="stat-label">Total Records</div><div class="stat-value" id="totalRecords">0</div><div class="stat-subtext">Total count</div></div>
      <div class="stat-card"><div class="stat-header"><div class="stat-icon pass">‚úÖ</div></div><div class="stat-label">Pass Count</div><div class="stat-value success" id="passCount">0</div><div class="stat-subtext">Successful tests</div></div>
      <div class="stat-card"><div class="stat-header"><div class="stat-icon fail">‚ùå</div></div><div class="stat-label">Fail Count</div><div class="stat-value danger" id="failCount">0</div><div class="stat-subtext">Failed tests</div></div>
      <div class="stat-card"><div class="stat-header"><div class="stat-icon rate">üìä</div></div><div class="stat-label">Pass Rate</div><div class="stat-value" id="passRate">0%</div><div class="stat-subtext">Success percentage</div></div>
    </section>
    <section class="table-section">
      <div class="table-header"><h3>üìã Records (<span id="recordCount">0</span>)</h3><button class="btn btn-secondary" onclick="exportData()">üíæ Export Data</button></div>
      <table><thead><tr id="tableHeaders"></tr></thead><tbody id="recordsTable"></tbody></table>
    </section>
  </div>
  <script>
    let currentFilters = { table: '', date: new Date().toISOString().split('T')[0], shift: 'all', identifier: 'all' };
    let allRecords = [];

    window.addEventListener('DOMContentLoaded', async () => {
      await loadUserInfo();
      setCurrentDate();
      await loadAvailableTables();
    });

    async function loadUserInfo() {
      try {
        const user = await window.api?.getCurrentUser?.() || { name: 'User', role: 'Operator' };
        document.getElementById('userName').textContent = user.name;
        document.getElementById('userRole').textContent = user.role;
        document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    function setCurrentDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateFilter').value = today;
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', options);
    }

    function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
    function showError(message) {
      document.getElementById('errorContainer').innerHTML = `<div class="error-message"><h3>‚ö†Ô∏è Error</h3><p>${message}</p><button class="btn btn-primary" onclick="openSettings()" style="margin-top: 1rem;">Open Settings</button></div>`;
    }
    function hideError() { document.getElementById('errorContainer').innerHTML = ''; }

    async function loadAvailableTables() {
      try {
        showLoading();
        const tables = await window.api?.getTablesList?.() || [];
        console.log('üìä Available tables:', tables);
        const tableSelector = document.getElementById('tableSelector');
        tableSelector.innerHTML = '<option value="">-- Select a Table --</option>';
        tables.forEach(table => {
          const option = document.createElement('option');
          option.value = table;
          option.textContent = table;
          tableSelector.appendChild(option);
        });
        if (tables.length > 0) {
          tableSelector.value = tables[0];
          currentFilters.table = tables[0];
          await onTableChange();
        }
        hideLoading();
      } catch (error) {
        console.error('Error loading tables:', error);
        showError('Failed to load tables. Please check database configuration.');
        hideLoading();
      }
    }

    async function onTableChange() {
      const selectedTable = document.getElementById('tableSelector').value;
      if (!selectedTable) {
        document.getElementById('currentTableDisplay').textContent = 'No Table Selected';
        clearData();
        return;
      }
      currentFilters.table = selectedTable;
      document.getElementById('currentTableDisplay').textContent = selectedTable;
      console.log('Table selected:', selectedTable);
      document.getElementById('identifierFilter').innerHTML = '<option value="all">All</option>';
      currentFilters.identifier = 'all';
      await loadIdentifierValues();
      await loadAllRecords();
    }

    async function loadIdentifierValues() {
      try {
        if (!currentFilters.table) return;
        const values = await window.api?.getUniqueIdentifiers?.(currentFilters.table) || [];
        const filterSelect = document.getElementById('identifierFilter');
        const filterLabel = document.getElementById('identifierLabel');
        filterSelect.innerHTML = '<option value="all">All</option>';
        if (values.length > 0 && values[0].columnName) {
          filterLabel.textContent = values[0].columnName;
          values[0].values.forEach(val => {
            const option = document.createElement('option');
            option.value = val;
            option.textContent = val;
            filterSelect.appendChild(option);
          });
        } else {
          filterLabel.textContent = 'Filter';
        }
      } catch (error) {
        console.error('Error loading identifier values:', error);
      }
    }

    async function loadAllRecords() {
      try {
        if (!currentFilters.table) { clearData(); return; }
        showLoading();
        hideError();
        console.log('üîç Loading records:', currentFilters);
        const response = await window.api?.getAllRecords?.(currentFilters) || { records: [], columns: [], stats: { total: 0, pass: 0, fail: 0 } };
        allRecords = response.records || [];
        console.log('‚úÖ Loaded', allRecords.length, 'records from', currentFilters.table);
        updateStats(response.stats || { total: 0, pass: 0, fail: 0 });
        document.getElementById('recordCount').textContent = allRecords.length;
        updateRecordsTable(allRecords, response.columns);
        hideLoading();
      } catch (error) {
        console.error('‚ùå Error:', error);
        showError(error.message || 'Failed to load data');
        clearData();
        hideLoading();
      }
    }

    function updateStats(stats) {
      document.getElementById('totalRecords').textContent = stats.total || 0;
      document.getElementById('passCount').textContent = stats.pass || 0;
      document.getElementById('failCount').textContent = stats.fail || 0;
      const rate = stats.total > 0 ? ((stats.pass / stats.total) * 100).toFixed(1) : 0;
      document.getElementById('passRate').textContent = rate + '%';
    }

    function updateRecordsTable(records, columns) {
      const tableHeaders = document.getElementById('tableHeaders');
      const tableBody = document.getElementById('recordsTable');
      tableHeaders.innerHTML = '';
      tableBody.innerHTML = '';
      if (!records || records.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10" class="no-data-message"><div><p style="font-size: 1.2rem; margin-bottom: 0.5rem;">üì≠ No Records Found</p><p>No data available.</p></div></td></tr>';
        return;
      }
      const firstRecord = records[0];
      const columnNames = columns && columns.length > 0 ? columns : Object.keys(firstRecord);
      columnNames.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        tableHeaders.appendChild(th);
      });
      records.forEach(record => {
        const row = document.createElement('tr');
        row.onclick = () => showRecordDetails(record);
        columnNames.forEach(col => {
          const td = document.createElement('td');
          const value = record[col];
          if (value && (col.toLowerCase().includes('date') || col.toLowerCase().includes('time'))) {
            try { td.textContent = new Date(value).toLocaleString(); }
            catch { td.textContent = value || '-'; }
          } else {
            td.textContent = value !== null && value !== undefined ? value : '-';
          }
          row.appendChild(td);
        });
        tableBody.appendChild(row);
      });
    }

    async function showRecordDetails(record) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      modalTitle.textContent = `Details for: ${Object.values(record)[0]}`;
      showLoading();
      try {
        const history = await window.api?.getRecordHistory?.(record, currentFilters.table) || [];
        if (history.length === 0) {
          modalContent.innerHTML = '<div class="no-data-message"><p style="font-size: 1.2rem;">üì≠ No History Found</p></div>';
        } else {
          const columns = Object.keys(history[0]);
          let tableHTML = '<table class="detail-table"><thead><tr>';
          columns.forEach(col => { tableHTML += `<th>${col}</th>`; });
          tableHTML += '</tr></thead><tbody>';
          history.forEach(row => {
            tableHTML += '<tr>';
            columns.forEach(col => {
              const value = row[col];
              let displayValue = value;
              if (value && (col.toLowerCase().includes('date') || col.toLowerCase().includes('time'))) {
                try { displayValue = new Date(value).toLocaleString(); }
                catch { displayValue = value || '-'; }
              } else {
                displayValue = value !== null && value !== undefined ? value : '-';
              }
              tableHTML += `<td>${displayValue}</td>`;
            });
            tableHTML += '</tr>';
          });
          tableHTML += '</tbody></table>';
          modalContent.innerHTML = tableHTML;
        }
        modal.classList.add('active');
        hideLoading();
      } catch (error) {
        console.error('Error loading history:', error);
        modalContent.innerHTML = '<div class="no-data-message"><p style="color: var(--accent-danger);">‚ùå Error</p><p>' + error.message + '</p></div>';
        modal.classList.add('active');
        hideLoading();
      }
    }

    function closeModal() { document.getElementById('detailModal').classList.remove('active'); }
    window.onclick = function(event) { if (event.target === document.getElementById('detailModal')) closeModal(); }

    function clearData() {
      document.getElementById('totalRecords').textContent = '0';
      document.getElementById('passCount').textContent = '0';
      document.getElementById('failCount').textContent = '0';
      document.getElementById('passRate').textContent = '0%';
      document.getElementById('recordCount').textContent = '0';
      document.getElementById('tableHeaders').innerHTML = '';
      document.getElementById('recordsTable').innerHTML = '';
      allRecords = [];
    }

    function applyFilters() {
      if (!currentFilters.table) { alert('Please select a table first'); return; }
      currentFilters.date = document.getElementById('dateFilter').value;
      currentFilters.shift = document.getElementById('shiftFilter').value;
      currentFilters.identifier = document.getElementById('identifierFilter').value;
      console.log('Applying filters:', currentFilters);
      loadAllRecords();
    }

    document.getElementById('tableSelector').addEventListener('change', onTableChange);
    document.getElementById('dateFilter').addEventListener('change', applyFilters);
    document.getElementById('shiftFilter').addEventListener('change', applyFilters);
    document.getElementById('identifierFilter').addEventListener('change', applyFilters);

    async function exportData() {
      if (allRecords.length === 0) { alert('No data to export'); return; }
      try {
        if (window.api && window.api.exportData) {
          await window.api.exportData({ records: allRecords }, currentFilters);
        } else {
          const columns = Object.keys(allRecords[0]);
          let csv = columns.join(',') + '\n';
          allRecords.forEach(record => {
            const row = columns.map(col => {
              const value = record[col];
              return value !== null && value !== undefined ? `"${value}"` : '';
            });
            csv += row.join(',') + '\n';
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${currentFilters.table}_${currentFilters.date}.csv`;
          a.click();
        }
      } catch (error) {
        console.error('Export error:', error);
        alert('Failed to export: ' + error.message);
      }
    }

    async function openSettings() { if (window.api && window.api.openSettings) await window.api.openSettings(); }
    function logout() { if (window.api && window.api.logout) window.api.logout(); }
  </script>
</body>
</html>